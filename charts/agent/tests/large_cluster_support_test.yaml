suite: Test Agent large cluster support with Daemonset+Deployment
templates:
  - templates/configmap.yaml
  - templates/configmap-deployment.yaml
  - templates/daemonset.yaml
  - templates/deployment.yaml
tests:
  - it: Enable Large Cluster support
    set:
      largeClusterSupport:
        enabled: true
    asserts:
      - containsDocument:
          kind: DaemonSet
          apiVersion: apps/v1
        template: templates/daemonset.yaml
      - containsDocument:
          kind: Deployment
          apiVersion: apps/v1
        template: templates/deployment.yaml
      - containsDocument:
          kind: ConfigMap
          apiVersion: v1
        template: templates/configmap.yaml
      - containsDocument:
          kind: ConfigMap
          apiVersion: v1
        template: templates/configmap-deployment.yaml

  - it: Check deployment metadata
    chart:
      version: 1.5.61
      appVersion: 12.11.0
    release:
      name: sysdig
      namespace: sysdig
    set:
      largeClusterSupport:
        enabled: true
    asserts:
      - equal:
          path: metadata
          value:
            name: sysdig-agent
            namespace: sysdig
            labels:
              app: sysdig-agent
              app.kubernetes.io/instance: sysdig
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: agent
              app.kubernetes.io/version: 12.11.0
              helm.sh/chart: agent-1.5.61
    template: templates/deployment.yaml

  - it: Test progressDeadlineSeconds
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          progressDeadlineSeconds: 30
    asserts:
      - equal:
          path: spec.progressDeadlineSeconds
          value: 30
    template: templates/deployment.yaml

  - it: Test replica setting
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          replicas: 20
    asserts:
      - equal:
          path: spec.replicas
          value: 20
    template: templates/deployment.yaml

  - it: Revision history limit
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          revisionHistoryLimit: 25
    asserts:
      - equal:
          path: spec.revisionHistoryLimit
          value: 25
    template: templates/deployment.yaml

  - it: Test matchLabels
    release:
      name: sg1
    set:
      largeClusterSupport:
        enabled: true
    asserts:
      - equal:
          path: spec.selector.matchLabels
          value:
            app.kubernetes.io/instance: sg1
            app.kubernetes.io/name: agent
    template: templates/deployment.yaml

  - it: Test Update Strategy defaults
    set:
      largeClusterSupport:
        enabled: true
    asserts:
      - equal:
          path: spec.strategy
          value:
            rollingUpdate:
              maxSurge: 25%
              maxUnavailable: 25%
            type: RollingUpdate
        template: templates/deployment.yaml

  - it: Test nodeSelector
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          nodeSelector:
            cpu: quantum
            memoryVolatile: extremely
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            cpu: quantum
            memoryVolatile: extremely
    template: templates/deployment.yaml

  - it: Change Deployment affinity
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: topology.kubernetes.io/zone
                        operator: In
                        values:
                          - stargate-command
    asserts:
      - equal:
          path: spec.template.spec.affinity
          value:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: topology.kubernetes.io/zone
                        operator: In
                        values:
                          - stargate-command
        template: templates/deployment.yaml

  - it: Change CPU architectures and OS types allowed for the deployment (OpenShift 3)
    capabilities:
      majorVersion: "1"
      minorVersion: "13"
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          arch:
            - IA64
          os:
            - HP-UX
    asserts:
      - equal:
          path: spec.template.spec.affinity
          value:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: beta.kubernetes.io/arch
                        operator: In
                        values:
                          - IA64
                      - key: beta.kubernetes.io/os
                        operator: In
                        values:
                          - HP-UX
    template: templates/deployment.yaml

  - it: Change CPU architectures and OS types allowed for the deployment
    capabilities:
      majorVersion: "1"
      minorVersion: "26"
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          arch:
            - IA64
          os:
            - HP-UX
    asserts:
      - equal:
          path: spec.template.spec.affinity
          value:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: kubernetes.io/arch
                        operator: In
                        values:
                          - IA64
                      - key: kubernetes.io/os
                        operator: In
                        values:
                          - HP-UX
    template: templates/deployment.yaml

  - it: Image Pull Secrets
    set:
      image:
        pullSecrets:
          - name: P2X-3YZ
      largeClusterSupport:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: P2X-3YZ
    templates:
      - templates/daemonset.yaml
      - templates/deployment.yaml

  - it: Test container image
    set:
      image:
        tag: 86.753.09
      largeClusterSupport:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "quay.io/sysdig/agent-slim:86.753.09"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent
    templates:
      - templates/daemonset.yaml
      - templates/deployment.yaml

  - it: Test container resource constraints
    set:
      largeClusterSupport:
        enabled: true
        deployment:
          resources:
            limits:
              cpu: 1000m
              memory: 1Gi
            requests:
              cpu: 250m
              memory: 384Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            limits:
              cpu: 1000m
              memory: 1Gi
            requests:
              cpu: 250m
              memory: 384Mi
    template: templates/deployment.yaml

  - it: Test container proxy settings (Deployment)
    set:
      largeClusterSupport:
        enabled: true
      proxy:
        httpProxy: 192.168.10.2
        httpsProxy: 192.168.10.3
        noProxy: 192.168.10.4
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: RUN_MODE
              value: nodriver
            - name: K8S_NODE
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: http_proxy
              value: 192.168.10.2
            - name: https_proxy
              value: 192.168.10.3
            - name: no_proxy
              value: 192.168.10.4
    template: templates/deployment.yaml

  - it: Test container proxy settings (Daemonset)
    set:
      largeClusterSupport:
        enabled: true
      proxy:
        httpProxy: 192.168.10.2
        httpsProxy: 192.168.10.3
        noProxy: 192.168.10.4
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: K8S_NODE
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: http_proxy
              value: 192.168.10.2
            - name: https_proxy
              value: 192.168.10.3
            - name: no_proxy
              value: 192.168.10.4
        template: templates/daemonset.yaml
